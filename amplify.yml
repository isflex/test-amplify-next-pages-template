version: 1
applications:
  -
    backend:
      phases:
        preBuild:
          commands: 
            - 'npm install -g pnpm'
        build:
          # commands: ['npm ci --cache .npm --prefer-offline', 'npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID']
          # commands:
          #   - npm ci --cache .npm --prefer-offline
          #   - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
          commands:
            - pnpm install --frozen-lockfile
            - pwd
            # - npx --use-pnpm ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID --debug
            - pnpm dlx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID --debug
      cache:
        paths:
          - 'node_modules/**/*'
    frontend:
      phases:
        preBuild:
          commands: 
            - 'npm install -g pnpm'
        build:
          commands: 
            - 'pnpm turbo run build --filter=gateway'
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - '.next/cache/**/*'
          - 'node_modules/**/*'
      buildPath: apps/gateway
    appRoot: apps/gateway